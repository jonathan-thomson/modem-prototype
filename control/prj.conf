# Minimal boilerplate config
CONFIG_PRINTK=y

CONFIG_CMSIS_RTOS_V2=y                # Use V2 of CMSIS RTOS API required by pRTOS implementation
CONFIG_CONSOLE=y
CONFIG_PICOLIBC=y                     # Use picolibc as C standard library
CONFIG_POLL=y                         # Enable Asynchronous notification framework used in pRTOS

CONFIG_STDOUT_CONSOLE=y       # Redirect STDOUT to a console until proper logging is in place

# Other / Floating Point Services
CONFIG_FPU=y          # Let Zephyr be floating point aware. See https://gitlab.fphcare.com/cpap-software/waitara/waitara/-/issues/432 for additional info
CONFIG_FPU_SHARING=y  # Multiple threads will use floating point operations.


# Custom Linker script 
CONFIG_HAVE_CUSTOM_LINKER_SCRIPT=y # Ensure image is even sized for bootloader 
CONFIG_CUSTOM_LINKER_SCRIPT="linker-script.ld"

### /Zephyr feature selection ###

### Temp for Devboard to P2 board bringup ###
CONFIG_USE_SEGGER_RTT=y
CONFIG_SEGGER_RTT_SECTION_NONE=y
CONFIG_RTT_CONSOLE=y
CONFIG_LOG_BACKEND_RTT=y
### / Temp for Devboard to P2 board bringup ###

### PicoLibC Configuration ***
# Don't use module to reduce local & pipeline build times
#CONFIG_PICOLIBC_USE_MODULE=y
### /PicoLibC Configuration ***

####  RTOS Configuration ###
CONFIG_MAIN_STACK_SIZE=3072
                                        # Keeping main stack size to be 2K to allow sufficient stack space for inits to happen
CONFIG_THREAD_NAME=y                    # Allow tracing to display thread name for debugging
CONFIG_THREAD_STACK_INFO=y              # Allow each thread to store thread stack info in k_thread data structure
CONFIG_THREAD_MONITOR=y                 # Instruct kernel to maintain a list of all threads for debugging
CONFIG_THREAD_RUNTIME_STATS=y           # Gather thread runtime statistics. For example: Thread total execution cycles, System total execution cycles. Used for monitoring of scheduler performance
CONFIG_SCHED_THREAD_USAGE=y             # Collect thread runtime usage. Used for monitoring of scheduler performance
CONFIG_INIT_STACKS=y                    # Initialise stacks with a known value so that high water mark can be determined for debugging
                                        # Init value: 0xAA
CONFIG_NUM_COOP_PRIORITIES=0
                                        # Default: 16, we do not use coop task now. Need to open if needed.
CONFIG_PRIORITY_CEILING=0
                                        # If cooperative task is disabled, ceiling priority should be 0, not -127(default)

CONFIG_SYS_CLOCK_TICKS_PER_SEC=10000
                                        # Using value greater than default to increase precision in delays
CONFIG_NUM_PREEMPT_PRIORITIES=56
                                        # Max priority in CMSIS v2. osPriority_t
CONFIG_USERSPACE=n                      # This option ennable threads in user mode to protect kernel
                                        # In current implementation, CMSIS v2 doesn't support options.
CONFIG_HW_STACK_PROTECTION=y            # Catch stack overflows when in privileged mode
CONFIG_STACK_CANARIES=y                 # Inserts a canary value into the stack frame when a function is entered and validates this value upon exit
                                        # Decrease performance. Only for initial state of project.
CONFIG_STACK_CANARIES_ALL=y             # equivalent to GCC option `-fstack-protector-all`
CONFIG_ENTROPY_GENERATOR=y              # CONFIG_STACK_CANARIES dependent option. Used to generate random number for Canary value
CONFIG_NUM_MBOX_ASYNC_MSGS=10
                                        # Default: 10, the total number of asynchronous mailbox messages that can exist simultaneously                                         

# Configuring timeslice size to 1 allows threads on same priority to get execution time every 1 ms. This is
# needed for:
#   - usb_mcx & usbworkq - dependency of device data.
CONFIG_TIMESLICING=y
CONFIG_TIMESLICE_SIZE=1

####  /RTOS Configuration ###

#### CMSIS Configuration ###
CONFIG_CMSIS_V2_THREAD_MAX_STACK_SIZE=8192
                                            # FIXME: Did not think this was required but removing results in run time assertion on dev board
CONFIG_CMSIS_V2_THREAD_DYNAMIC_MAX_COUNT=0
                                            # Define static memory size for dynamic thread in CMSIS
CONFIG_CMSIS_V2_MSGQ_MAX_DYNAMIC_SIZE=0
                                            # Don't allow CMSIS dynamic queues as it violates coding standard

#####
## Following max count is for static memory allocation for OS service in CMSIS V2
## Thread : Only for the number of TCB. Task stack is allocated in Application.
## Queue  : App allocates memory for message and message queue object is allocated from static memory.
## Timer, Mutex, Semaphore, Event : Static memory allocated in CMSIS for these service.
## Memory pool: Fixed size heap. Not needed.
## NOTE : Slap memory internally used in Zephyr is a kind of dynamic memory, but it should be an exception
##        of coding standard. This is an essential feature in zephyr for OS service, such as Queue, Timer,
##        Mutex, Semaphore and Event etc.
####
CONFIG_CMSIS_V2_THREAD_MAX_COUNT=10
                                            # Maximum number of threads, arbitrary value >= current usage
CONFIG_CMSIS_V2_TIMER_MAX_COUNT=10
                                            # Maximum number of timers, arbitrary value >= current usage
CONFIG_CMSIS_V2_EVT_FLAGS_MAX_COUNT=10
                                            # Default: 5, Need to be adjusted later
CONFIG_CMSIS_V2_MSGQ_MAX_COUNT=10
                                            # Default: 5, Memory for message is allocated by App.
                                            #             Memory for message queue is allocated from static
                                            # This max count define max number of message queue.
CONFIG_CMSIS_V2_MUTEX_MAX_COUNT=100
                                            # Default: 5, Need to be adjusted later
CONFIG_CMSIS_V2_SEMAPHORE_MAX_COUNT=20
                                            # Default: 5, Need to be adjusted later
CONFIG_CMSIS_V2_MEM_SLAB_MAX_COUNT=0
CONFIG_CMSIS_V2_MEM_SLAB_MAX_DYNAMIC_SIZE=0
                                            # Fixed size memory pool(similar to heap). No need for waitara
#### /CMSIS Configuration ###

#### Logging and Assertions ####
CONFIG_LOG=y                                # Compile in Zephyr log calls
# Force to y to ensure log output function pointer is valid from `log_format_func_t_get`. Needed for our custom backends if 
# CONFIG_LOG_BACKEND_RTT is not selected.
CONFIG_LOG_OUTPUT=y
CONFIG_LOG_MODE_DEFERRED=y                  # Enables async logging, i.e. processed later by a thread
CONFIG_LOG_PROCESS_THREAD=y                 # Let Zephyr create the logger thread
CONFIG_LOG_PROCESS_THREAD_STARTUP_DELAY_MS=10000
                                            # Adds delay to logging thread startup. Keeping it 10s to allow enough time
                                            # to connect and stream startup logs to Airvolab/Insight.
CONFIG_LOG_PROCESS_THREAD_STACK_SIZE=3072
CONFIG_LOG_PROCESS_THREAD_SLEEP_MS=10
                                            # Flush/Process logs every 10ms
CONFIG_LOG_PROCESS_TRIGGER_THRESHOLD=10
                                            # Threshold at which the buffered log messages are flushed/processed by logging thread.
                                            # Keeping it 10 (default). Since we have 100ms flush, this is an acceptable value.
CONFIG_LOG_BUFFER_SIZE=4096
                                            # Logging internal buffers that will hold the log messages (Keep it reasonably high to avoid losing messages)
CONFIG_LOG_RUNTIME_FILTERING=y              # Enable ability to change log filter level at runtime
CONFIG_LOG_OVERRIDE_LEVEL=0
                                            # Log override is disabled. Anything higher than 1 will cause MPU fault - Data Access Violation.
CONFIG_ASSERT=y                             # Enable asserts within the kernel
CONFIG_ASSERT_LEVEL=2
                                            # Enable asserts but don't warn on files that include __assert.h
CONFIG_LOG_BACKEND_SHOW_COLOR=n             # Disable colour support to avoid special characters appearing in smarttalk bogs
CONFIG_LOG_MODE_OVERFLOW=y                  # Drop the old messages if there is no space left for a new log message
CONFIG_LOG_DEFAULT_LEVEL=4
                                            # Set the default log level to DEBUG

#### Extras
CONFIG_REBOOT=y                       # Enable sys_reboot() API
CONFIG_BUILD_OUTPUT_HEX=y             # Generate Hex output
CONFIG_STD_C17=y                      # Use C17
CONFIG_COMPILER_OPT=""                # Compiler options for Zephyr kernel and project compilation. ex "-O0 -g3 "
CONFIG_KERNEL_BIN_NAME="control_app"  # Can change the output file name
CONFIG_WARN_DEPRECATED=y              # Print a warning when the Kconfig tree is parsed if any deprecated features are enabled.

CONFIG_FLASH=y
CONFIG_SPI_NOR=y                         # spi nor flash for W25Q128JV, JESD216 compatible
CONFIG_FLASH_MAP=y
CONFIG_SPI_NOR_FLASH_LAYOUT_PAGE_SIZE=4096
                                            # This will be block size(default : 65536)
CONFIG_SPI_LOG_LEVEL_ERR=y              # Only set in order to prevent a bug in spi_nxp_lpspi.c causing compilation warnings 
CONFIG_INPUT=y
CONFIG_INPUT_THREAD_STACK_SIZE=2048

# Allows memory manager to make up to 5 attempts to find a chunk
# of the right size to mitigate potential heap fragmentation
CONFIG_SYS_HEAP_ALLOC_LOOPS=5

